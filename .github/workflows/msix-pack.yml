# .github/workflows/nightly-release.yml
name: Nightly Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write   # 创建/删除 release 需要

jobs:
  nightly:
    runs-on: windows-latest
    steps:
      # 1. 只检出最新一次提交，不需要拉 tag
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          fetch-tags: false   # 关键：不拉任何 tag，避免锁文件

      # 2. 安装 .NET
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3. 构建 & 打包
      - run: dotnet restore
      - run: dotnet build --no-restore -c Release
      # 5. 打包时关闭签名 → 生成未签名 msix
      - name: Publish & Pack (unsigned)
        shell: pwsh
        run: |
          dotnet publish --no-build -c Release `
            -p:Platform=x64 `
            -p:AppxPackageDir=MsixOutput `
            -p:UapAppxPackageBuildMode=StoreUpload `
            -p:AppxBundle=Never `
            -p:AppxPackageSigningEnabled=false

      # 6. 解码我们自己的证书
      - name: Prepare certificate
        shell: pwsh
        run: |
          $cert = [System.Convert]::FromBase64String("${{ secrets.MSIX_CERTIFICATE }}")
          [System.IO.File]::WriteAllBytes("$env:RUNNER_TEMP\ci.pfx", $cert)

      # 7. 对打包好的 msix 二次签名
      - name: Sign MSIX
        shell: pwsh
        run: |
          $msix = Get-ChildItem MsixOutput -Recurse -Filter *.msix | Select -First 1 -Exp FullName
          & "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign `
            /fd SHA256 /a /f "$env:RUNNER_TEMP\ci.pfx" /p "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" "$msix"
          if ($LASTEXITCODE -ne 0) { throw "Sign failed" }

      - name: Sign MSIX
        shell: pwsh
        run: |
          $msix = Get-ChildItem MsixOutput -Recurse -Filter *.msix | Select -First 1 -Exp FullName
          & "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign /fd SHA256 /a /f "$env:RUNNER_TEMP\cert.pfx" /p "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" "$msix"
          if ($LASTEXITCODE -ne 0) { throw "Sign failed" }

      # 5. 生成 changelog
      - name: Changelog
        shell: pwsh
        run: |
          # 取最近 20 条提交
          $log = (git log --oneline -20 --format="%h %s") -join "`n"
          $body = @"
          ## 最近更改 (最近20次提交)
          $log

          ## 预发布版本说明
          - **CzkCloud 扫描引擎暂不可用**
          - 仅供测试，随时可能回滚
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 本次提交: ${{ github.sha }}
          "@
          $body | Out-File -FilePath release_notes.md -Encoding UTF8

      # 6. 打包成 Xdows-Security.zip
      - name: Create zip
        shell: pwsh
        run: |
          $pkgDir = Get-ChildItem MsixOutput -Directory | Select -First 1 -Exp FullName
          Compress-Archive -Path "$pkgDir\*" -DestinationPath Xdows-Security.zip

      # 7. 纯 API 方式发布 / 覆盖 Release（不执行本地 git tag）
      - name: Publish Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          # 如果已存在就删除
          gh api repos/${{ github.repository }}/releases/tags/Nightly `
            --silent -X DELETE 2>$null

          # 新建 release（GitHub 会自动创建 lightweight tag Nightly 指向当前 SHA）
          gh release create Nightly Xdows-Security.zip `
            --title "Nightly" `
            --notes-file release_notes.md `
            --prerelease `
            --target ${{ github.sha }}