name: Build & Prerelease MSIX

permissions:
  contents: write

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  DOTNET_VERSION: '8.0.x'
  CSPROJ_PATH: 'Xdows-Security/Xdows-Security.csproj'
  RID: 'win-x64'
  CONFIGURATION: 'Release'
  TARGET_FRAMEWORK: 'net8.0-windows10.0.19041.0'

jobs:
  build-and-pack:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Patch System.Security.Permissions for BuildTools 1.7
      shell: pwsh
      run: |
        # 1. 找到 .NET 8 SDK 根
        $sdkLine = dotnet --list-sdks | Where-Object { $_ -match '^8\.0\.\d+\s+\[(.+)\]' }
        if (-not $sdkLine) { throw ".NET 8 SDK not found" }
        $sdkRoot = $Matches[1]
        $targetDir = Join-Path $sdkRoot 'Microsoft'
        New-Item -ItemType Directory -Force $targetDir | Out-Null

        # 2. 用 NuGet CLI 下载包（不依赖项目）
        $tmpPkg = "$env:RUNNER_TEMP\patchPkg"
        nuget install System.Security.Permissions -Version 8.0.0 -OutputDirectory $tmpPkg
        $dll = Get-ChildItem $tmpPkg -Recurse -Filter System.Security.Permissions.dll | Select-Object -First 1
        if (-not $dll) { throw "DLL still not found" }

        # 3. 复制到 SDK 目录
        Copy-Item $dll.FullName $targetDir -Force
        Write-Host "Patched -> $targetDir"
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Prepare signing certificate
      shell: pwsh
      run: |
        $errPref = 'Stop'
        $certPath = "$env:RUNNER_TEMP\cert.pfx"

        $bytes = [Convert]::FromBase64String("${{ secrets.MSIX_CERTIFICATE }}")
        [IO.File]::WriteAllBytes($certPath, $bytes)

        $securePwd = ConvertTo-SecureString -String "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" -Force -AsPlainText
        $cert = Import-PfxCertificate -FilePath $certPath `
                                  -CertStoreLocation Cert:\CurrentUser\My `
                                  -Password $securePwd `
                                  -Exportable

        $eku = $cert.Extensions | Where-Object { $_ -is [System.Security.Cryptography.X509Certificates.X509EnhancedKeyUsageExtension] }
        if ($eku.EnhancedKeyUsages['1.3.6.1.5.5.7.3.3'] -eq $null) {
            throw "Certificate missing Code Signing EKU (1.3.6.1.5.5.7.3.3)"
        }

        echo "CERT_THUMBPRINT=$($cert.Thumbprint)" >> $env:GITHUB_ENV
        
    - name: Build and create signed MSIX package
      shell: pwsh
      run: |
        Write-Host "Building and creating signed MSIX package..."
        
        dotnet publish ${{ env.CSPROJ_PATH }} `
          -c ${{ env.CONFIGURATION }} `
          -r ${{ env.RID }} `
          --self-contained true `
          -p:PublishAppxPackage=true `
          -p:AppxPackageSigningEnabled=true `
          -p:PackageCertificateThumbprint=${{ env.CERT_THUMBPRINT }} `
          -p:PackageCertificatePassword="${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" `
          -p:GenerateAppxPackageOnBuild=true `
          -p:AppxBundle=Never `
          -p:UapAppxPackageBuildMode=CI `
          -p:PublishReadyToRun=false `
          -p:PublishTrimmed=false `
          --verbosity normal
          
        if ($LASTEXITCODE -ne 0) {
            Write-Error "MSIX package creation failed"
            exit 1
        }
        
        Write-Host "Signed MSIX package created successfully"
        
    - name: Locate MSIX package
      id: locate-msix
      shell: pwsh
      run: |
        $outDir = "${{ github.workspace }}/Xdows-Security/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}/${{ env.RID }}/AppPackages"
        Write-Host "Looking for MSIX in: $outDir"

        $msixFolder = Get-ChildItem $outDir -Directory -Filter "*_Test" | Select-Object -First 1
        if (-not $msixFolder) {
            $msixFolder = Get-ChildItem $outDir -Directory | Select-Object -First 1
        }
        if (-not $msixFolder) {
            throw "No MSIX output folder found"
        }

        $msixFile = Get-ChildItem $msixFolder.FullName -Filter "*.msix" | Select-Object -First 1
        if (-not $msixFile) {
            throw "No .msix file found"
        }

        Write-Host "Found MSIX: $($msixFile.FullName)"
        echo "MSIX_PATH=$($msixFile.FullName)"   >> $env:GITHUB_ENV
        echo "MSIX_DIR=$($msixFolder.FullName)" >> $env:GITHUB_ENV
    - name: Generate changelog
      id: changelog
      shell: pwsh
      run: |
        $log = (git log --oneline -20 --format="%h %s (%an)") -join "`n"
        $changelog = @"
        ## 最近更改 (最近20次提交)
        $log

        ## 预发布版本说明
        - **CzkCloud 扫描引擎暂不可用**
        - 仅供测试，随时可能回滚
        - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        - 提交: ${{ github.sha }}
        "@
        echo "CHANGELOG<<EOF" >> $env:GITHUB_OUTPUT
        echo "$changelog" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
        
    - name: Prepare release assets
      shell: pwsh
      run: |
        Write-Host "Preparing release assets..."
        
        # 复制证书文件
        if (Test-Path "Certs/Cert.cer") {
            Copy-Item "Certs/Cert.cer" "${{ env.MSIX_DIR }}/Cert.cer"
            Write-Host "Certificate copied"
        }
        
        # 创建ZIP包
        $zipName = "Xdows-Security-$(Get-Date -Format 'yyyyMMdd-HHmm')-Signed.zip"
        Compress-Archive -Path "${{ env.MSIX_DIR }}\*" -DestinationPath $zipName
        
        # 验证ZIP文件
        if (Test-Path $zipName) {
            $zipInfo = Get-Item $zipName
            Write-Host "ZIP created: $($zipInfo.Name) ($([math]::Round($zipInfo.Length/1MB, 2)) MB)"
            echo "ZIP_PATH=$zipName" >> $env:GITHUB_ENV
        } else {
            throw "ZIP file creation failed"
        }
        
    - name: Create prerelease
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: nightly-$(date +'%Y%m%d-%H%M%S')
        name: Nightly Build $(date +'%Y-%m-%d %H:%M')
        prerelease: true
        make_latest: false
        files: ${{ env.ZIP_PATH }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        
    - name: Upload artifact (for PRs)
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: msix-package
        path: ${{ env.ZIP_PATH }}
        retention-days: 1