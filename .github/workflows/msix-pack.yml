name: Nightly Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: nightly-release
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Clean Git locks
        run: |
          Remove-Item -Force -ErrorAction SilentlyContinue "$env:GITHUB_WORKSPACE\.git\refs\tags\*.lock"
          Remove-Item -Force -ErrorAction SilentlyContinue "$env:GITHUB_WORKSPACE\.git\*.lock"
        continue-on-error: true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare certificate
        shell: pwsh
        run: |
          $certBytes = [Convert]::FromBase64String("${{ secrets.MSIX_CERTIFICATE }}")
          $certPath = "$env:RUNNER_TEMP\cert.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)
          Write-Output "CERT_PATH=$certPath" >> $env:GITHUB_ENV

      - name: Sign artifacts
        shell: pwsh
        run: |
          $files = Get-ChildItem -Recurse -Include *.msix,*.appx,*.exe
          foreach ($f in $files) {
            Write-Host "Signing $f"
            signtool sign /f "$env:CERT_PATH" /p "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" /t http://timestamp.digicert.com /v $f
          }

      - name: Create source zip
        shell: pwsh
        run: |
          7z a nightly.zip ${{ github.workspace }} -xr'!.git' -xr'!.github'

      - name: Build changelog
        id: changelog
        shell: pwsh
        run: |
          $log = (git log --oneline -20 --format="%h %s") -join "`n"
          $note = @"
          ## 最近更改 (最近20次提交)
          $log

          ## 预发布版本说明
          - **CzkCloud 扫描引擎暂不可用**
          - 仅供测试，随时可能回滚
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 本次提交: ${{ github.sha }}
          "@
          $note = $note -replace '%','%25' -replace "`n",'%0A' -replace "`r",'%0D'
          "BODY=$note" >> $env:GITHUB_OUTPUT

      - name: Release
        uses: ncipollo/release-action@v1
        with:
          tag: Nightly
          name: Nightly
          body: ${{ steps.changelog.outputs.BODY }}
          artifacts: nightly.zip
          artifactContentType: application/zip
          prerelease: true
          allowUpdates: true
          removeArtifacts: true
