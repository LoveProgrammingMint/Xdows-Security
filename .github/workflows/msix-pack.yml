# .github/workflows/nightly-release.yml
name: Nightly Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # 1. 在 Linux 上强制覆盖 nightly tag（无文件锁）
  retag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          fetch-depth: 0
      - name: Force recreate nightly tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f nightly ${{ github.sha }}
          git push -f origin nightly

  # 2. 在 Windows 上构建、签名、打包、上传 Release
  build-pack-sign-release:
    needs: retag          # 等 tag 重建完成再执行
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore -c Release

      - name: Package MSIX
        run: dotnet publish --no-build -c Release -p:Platform=x64 -p:AppxPackageDir=MsixOutput -p:UapAppxPackageBuildMode=StoreUpload -p:AppxBundle=Never

      - name: Prepare certificate
        shell: pwsh
        run: |
          $certBytes = [System.Convert]::FromBase64String("${{ secrets.MSIX_CERTIFICATE }}")
          [System.IO.File]::WriteAllBytes("$env:RUNNER_TEMP\cert.pfx", $certBytes)

      - name: Sign MSIX
        shell: pwsh
        run: |
          $msix = Get-ChildItem MsixOutput -Recurse -Filter *.msix | Select -First 1 -Exp FullName
          & "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign /fd SHA256 /a /f "$env:RUNNER_TEMP\cert.pfx" /p "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" "$msix"
          if ($LASTEXITCODE -ne 0) { throw "Sign failed" }

      - name: Generate changelog
        id: cl
        shell: pwsh
        run: |
          $log = (git log --oneline -20 --format="%h %s") -join "`n"
          @"
          ## 最近更改 (最近20次提交)
          $log

          ## 预发布版本说明
          - **CzkCloud 扫描引擎暂不可用**
          - 仅供测试，随时可能回滚
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 本次提交: ${{ github.sha }}
          "@ | Out-File -FilePath CHANGELOG.md -Encoding UTF8

      - name: Create zip
        shell: pwsh
        run: |
          $pkgDir = Get-ChildItem MsixOutput -Directory | Select -First 1 -Exp FullName
          Compress-Archive -Path "$pkgDir\*" -DestinationPath Xdows-Security.zip

      # 直接利用 gh cli 上传（tag 已存在，无需再创建）
      - name: Upload nightly release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: pwsh
        run: |
          gh release view nightly --json url | Out-Null
          if ($LASTEXITCODE -eq 0) {
            gh release delete nightly --yes          # 删除旧 release（保留 tag）
          }
          gh release create nightly Xdows-Security.zip `
            --title "Nightly" `
            --notes-file CHANGELOG.md `
            --prerelease `
            --target ${{ github.sha }}