name: Nightly Release

on:
  push:
    branches: [ main, master ]   # 需要触发签名的分支
  workflow_dispatch:             # 也可手动触发

permissions:
  contents: write               # 必须有写权限才能创建/覆盖 Release

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      # 0. 清掉可能存在的锁文件
      - name: Clean leftover git locks
        run: |
          Remove-Item -Force -ErrorAction SilentlyContinue `
            "$env:GITHUB_WORKSPACE\.git\refs\tags\*.lock"
          Remove-Item -Force -ErrorAction SilentlyContinue `
            "$env:GITHUB_WORKSPACE\.git\*.lock"

      # 1. 再正常 checkout
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 把证书从 Secret 还原出来
      - name: Prepare certificate
        shell: pwsh
        run: |
          $certBytes = [Convert]::FromBase64String("${{ secrets.MSIX_CERTIFICATE }}")
          $certPath = "$env:RUNNER_TEMP\cert.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)
          Write-Output "CERT_PATH=$certPath" >> $env:GITHUB_ENV

      # 3. 签名（示例：对根目录下所有 .msix/.appx/.exe 做签名，可按需改）
      - name: Sign artifacts
        shell: pwsh
        run: |
          $files = Get-ChildItem -Recurse -Include *.msix,*.appx,*.exe
          foreach ($f in $files) {
            Write-Host "Signing $f"
            signtool sign /f "$env:CERT_PATH" /p "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" /t http://timestamp.digicert.com /v $f
          }

      # 4. 打包仓库为 zip（含子模块）
      - name: Create source zip
        shell: pwsh
        run: |
          7z a nightly.zip ${{ github.workspace }} -xr'!.git' -xr'!.github'

      # 5. 生成 Release Note
      - name: Build changelog
        id: changelog
        shell: pwsh
        run: |
          $log = (git log --oneline -20 --format="%h %s") -join "`n"
          $note = @"
          ## 最近更改 (最近20次提交)
          $log

          ## 预发布版本说明
          - **CzkCloud 扫描引擎暂不可用**
          - 仅供测试，随时可能回滚
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 本次提交: ${{ github.sha }}
          "@
          # 多行文本输出到 GITHUB_OUTPUT
          $note = $note -replace '%','%25' -replace "`n",'%0A' -replace "`r",'%0D'
          "BODY=$note" >> $env:GITHUB_OUTPUT

      # 6. 强制更新/覆盖 Nightly Tag 并发布
      - name: Release
        uses: ncipollo/release-action@v1
        with:
          tag: Nightly
          name: Nightly
          body: ${{ steps.changelog.outputs.BODY }}
          artifacts: nightly.zip
          artifactContentType: application/zip
          prerelease: true
          allowUpdates: true          # 关键：存在则覆盖
          removeArtifacts: true       # 先删旧文件
