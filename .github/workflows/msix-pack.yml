name: Build & Prerelease MSIX

permissions:
  contents: write           # å…è®¸åˆ›å»º release
  pull-requests: read       # å…¶ä½™æƒé™æŒ‰éœ€å¼€

on:
  push:
    branches: [ master, main ]

env:
  DOTNET_VERSION: '8.0.x'
  CSPROJ_PATH: 'Xdows-Security/Xdows-Security.csproj'
  RID: 'win-x64'
  ARTIFACT_NAME: 'Xdows-Security-MSIX'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0          # è®© git èƒ½æ‹¿åˆ°æäº¤å†å²

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore
      run: >
        dotnet restore ${{ env.CSPROJ_PATH }}
        -r ${{ env.RID }}
        -p:PublishReadyToRun=false

    - name: Build
      run: >
        dotnet build ${{ env.CSPROJ_PATH }}
        -c Release
        -r ${{ env.RID }}
        --no-restore
        -p:PublishReadyToRun=false

    - name: Publish MSIX (Unsigned)
      run: >
        dotnet publish ${{ env.CSPROJ_PATH }}
        -c Release
        -r ${{ env.RID }}
        --self-contained true
        -p:PublishAppxPackage=true
        -p:AppxPackageSigningEnabled=false
        -p:PublishReadyToRun=false
        -p:PublishTrimmed=false
        -p:PublishProfile=
        -o artifacts

    - name: Zip package for upload
      shell: pwsh
      run: |
        Compress-Archive -Path "artifacts/*_Test/*" -DestinationPath "Xdows-Security-Unsigned.zip"

    # ç”Ÿæˆå˜æ›´æ—¥å¿—ï¼ˆæœ€è¿‘ 10 æ¡æäº¤ï¼‰
    - name: Generate changelog
      id: changelog
      shell: pwsh
      run: |
        $log = (git log --oneline -10) -join "`n"
        echo "CHANGELOG<<EOF" >> $env:GITHUB_OUTPUT
        echo "$log" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT

    # åˆ›å»ºé¢„å‘å¸ƒ Release
    # åˆ›å»ºé¢„å‘å¸ƒ Release
    - name: Create Prerelease
      uses: softprops/action-gh-release@v2
      with:
        tag_name: nightly-${{ github.run_number }}
        name: Nightly ${{ github.run_number }}
        prerelease: true
        files: Xdows-Security-Unsigned.zip
        body: >-
          ğŸš§ é¢„å‘å¸ƒç‰ˆæœ¬è¯´æ˜
          - æœªç­¾åï¼Œè¯·è‡ªè¡Œè§£å†³å®‰è£…é—®é¢˜
          - CzkCloud æ‰«æå¼•æ“æš‚ä¸å¯ç”¨
          - ä»…ä¾›æµ‹è¯•ï¼Œéšæ—¶å¯èƒ½å›æ»š

          ### æ›´æ–°æ—¥å¿—
          ```
          ${{ steps.changelog.outputs.CHANGELOG }}
          ```