name: Nightly Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: write   # 创建 release 需要

jobs:
  # 1. Windows 只做：构建、签名、打包、上传 artifact
  build-pack-sign:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - run: dotnet restore
      - run: dotnet build --no-restore -c Release
      - run: dotnet publish --no-build -c Release -p:Platform=x64 -p:AppxPackageDir=MsixOutput -p:UapAppxPackageBuildMode=StoreUpload -p:AppxBundle=Never

      - name: Prepare .pfx
        shell: pwsh
        run: |
          $b = [System.Convert]::FromBase64String("${{ secrets.MSIX_CERTIFICATE }}")
          [System.IO.File]::WriteAllBytes("$env:RUNNER_TEMP\cert.pfx", $b)

      - name: Sign MSIX
        shell: pwsh
        run: |
          $msix = Get-ChildItem MsixOutput -Recurse -Filter *.msix | Select -First 1 -Exp FullName
          & "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign /fd SHA256 /a /f "$env:RUNNER_TEMP\cert.pfx" /p "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" "$msix"
          if ($LASTEXITCODE -ne 0) { throw "Sign failed" }

      - name: Generate changelog
        shell: pwsh
        run: |
          $log = (git log --oneline -20 --format="%h %s") -join "`n"
          @"
          ## 最近更改 (最近20次提交)
          $log

          ## 预发布版本说明
          - **CzkCloud 扫描引擎暂不可用**
          - 仅供测试，随时可能回滚
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 本次提交: ${{ github.sha }}
          "@ | Out-File -FilePath CHANGELOG.md -Encoding UTF8

      - name: Create zip
        shell: pwsh
        run: |
          $dir = Get-ChildItem MsixOutput -Directory | Select -First 1 -Exp FullName
          Compress-Archive -Path "$dir\*" -DestinationPath Xdows-Security.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: msix-zip
          path: Xdows-Security.zip

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

  # 2. Linux 统一管 tag & release（无锁）
  release:
    needs: build-pack-sign
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          fetch-depth: 0

      - name: Download zip
        uses: actions/download-artifact@v4
        with:
          name: msix-zip
      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Force recreate nightly tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f nightly ${{ github.sha }}
          git push -f origin nightly

      - name: Create / overwrite nightly release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 如果已存在就删
          gh release view nightly >/dev/null 2>&1 && gh release delete nightly --yes
          # 新建
          gh release create nightly Xdows-Security.zip \
            --title "Nightly" \
            --notes-file CHANGELOG.md \
            --prerelease \
            --target ${{ github.sha }}