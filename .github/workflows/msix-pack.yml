name: Nightly Build

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Delete existing Nightly tag
        run: |
          git tag -d Nightly
          git push origin :Nightly

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build project
        run: dotnet build --no-restore --configuration Release

      - name: Pack project
        run: dotnet pack --no-build --configuration Release -o ./artifacts

      - name: Sign package
        env:
          MSIX_CERTIFICATE: ${{ secrets.MSIX_CERTIFICATE }}
          MSIX_CERTIFICATE_PASSWORD: ${{ secrets.MSIX_CERTIFICATE_PASSWORD }}
        run: |
          $certificateBytes = [System.Convert]::FromBase64String($env:MSIX_CERTIFICATE)
          $certificatePath = "certificate.pfx"
          [System.IO.File]::WriteAllBytes($certificatePath, $certificateBytes)
          dotnet sign ./artifacts/*.nupkg --certificate $certificatePath --password $env:MSIX_CERTIFICATE_PASSWORD

      - name: Create release directory
        run: |
          New-Item -ItemType Directory -Path "release"
          Copy-Item -Path "./artifacts/*" -Destination "release"

      - name: Create changelog
        run: |
          $log = (git log --oneline -20 --format="%h %s") -join "`n"
          $changelog = @"
          ## 最近更改 (最近20次提交)

          $log

          ## 预发布版本说明

          - **CzkCloud 扫描引擎暂不可用**
          - 仅供测试，随时可能回滚
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 本次提交: ${{ github.sha }}
          "@
          $changelog | Out-File -FilePath "release/changelog.txt" -Encoding utf8

      - name: Create zip file
        run: |
          Compress-Archive -Path "release/*" -DestinationPath "release.zip"

      - name: Create or update Nightly release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: Nightly
          release_name: Nightly
          body_path: release/changelog.txt
          draft: false
          prerelease: true
          overwrite: true

      - name: Upload release asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release.zip
          asset_name: release.zip
          asset_content_type: application/zip