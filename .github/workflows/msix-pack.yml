# .github/workflows/nightly-release.yml
name: Nightly Release

on:
  push:
    branches: [ main ]   # 需要触发的工作分支
  workflow_dispatch:     # 允许手动触发

permissions:
  contents: write        # 创建/删除 tag & release 需要写权限

jobs:
  build-pack-sign-release:
    runs-on: windows-latest

    steps:
      # 1. 检出代码
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 为了 git log 能拿到历史

      # 2. 安装 .NET SDK（根据你的项目框架自行调整版本）
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3. 还原 NuGet 依赖
      - name: Restore
        run: dotnet restore

      # 4. 编译项目（Release 模式）
      - name: Build
        run: dotnet build --no-restore -c Release

      # 5. 打包成 MSIX
      - name: Package MSIX
        run: dotnet publish --no-build -c Release -p:Platform=x64 -p:AppxPackageDir=MsixOutput -p:UapAppxPackageBuildMode=StoreUpload -p:AppxBundle=Never

      # 6. 把 Secret 中的 base64 证书解码成 .pfx 文件
      - name: Prepare certificate
        shell: pwsh
        run: |
          $certBytes = [System.Convert]::FromBase64String("${{ secrets.MSIX_CERTIFICATE }}")
          [System.IO.File]::WriteAllBytes("$env:RUNNER_TEMP\cert.pfx", $certBytes)

      # 7. 使用 signtool 对 MSIX 进行签名
      - name: Sign MSIX
        shell: pwsh
        run: |
          $msix = Get-ChildItem MsixOutput -Recurse -Filter *.msix | Select-Object -First 1 -ExpandProperty FullName
          & "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign /fd SHA256 /a /f "$env:RUNNER_TEMP\cert.pfx" /p "${{ secrets.MSIX_CERTIFICATE_PASSWORD }}" "$msix"
          if ($LASTEXITCODE -ne 0) { throw "Sign failed" }

      # 8. 生成更新日志
      - name: Generate changelog
        id: changelog
        shell: pwsh
        run: |
          $log = (git log --oneline -20 --format="%h %s") -join "`n"
          $change = @"
          ## 最近更改 (最近20次提交)
          $log

          ## 预发布版本说明
          - **CzkCloud 扫描引擎暂不可用**
          - 仅供测试，随时可能回滚
          - 构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - 本次提交: ${{ github.sha }}
          "@
          $change | Out-File -FilePath CHANGELOG.md -Encoding UTF8

      # 9. 把签名后的 AppPackages 文件夹压缩成 Xdows-Security.zip
      - name: Create zip
        shell: pwsh
        run: |
          $pkgDir = Get-ChildItem MsixOutput -Directory | Select-Object -First 1 -ExpandProperty FullName
          Compress-Archive -Path "$pkgDir\*" -DestinationPath Xdows-Security.zip

      # 10. 删除已存在的 nightly tag & release（实现覆盖）
      - name: Delete existing nightly release/tag
        continue-on-error: true
        shell: pwsh
        run: |
          gh release delete nightly --yes --cleanup-tag
        env:
          GH_TOKEN: ${{ github.token }}

      # 11. 创建新的 nightly release 并上传 zip
      - name: Create nightly release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly
          body_path: CHANGELOG.md
          prerelease: true
          files: Xdows-Security.zip
        env:
          GITHUB_TOKEN: ${{ github.token }}